# This is the name that appears in GitHub Actions tab
name: CI - BeloteEngine

# When should this workflow run?
on:
  push:
    branches: [ main ]  # Run on pushes to main
  pull_request:
    branches: [ main ]           # Run on PRs targeting main

# Define what jobs to run
jobs:
  # Job 1: Build and Test
  build-and-test:
    # What type of machine to run on (GitHub provides this for free)
    runs-on: ubuntu-latest
    
    steps:
      # Step 1: Get your code from the repository
      - name: Checkout code
        uses: actions/checkout@v4
        # This action is provided by GitHub - it downloads your repo
      
      # Step 2: Install . NET SDK
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.0'  # Match the version in your Dockerfile
      
      # Step 3: Restore dependencies (like npm install but for .NET)
      - name: Restore dependencies
        run: dotnet restore BeloteEngine.sln
        # This downloads all NuGet packages your project needs
      
      # Step 4: Build the project
      - name: Build
        run: dotnet build BeloteEngine.sln --configuration Release --no-restore
        # --configuration Release: Build optimized version
        # --no-restore: Skip restore (we already did it)
      
      # Step 5: Run tests (if you have any)
      - name: Run tests
        run: dotnet test BeloteEngine.sln --no-build --verbosity normal
        # --no-build: Use the already-built code
        # --verbosity normal: Show test output
        # Note: This will pass even if you have no tests yet
  
  # Job 2: Build Docker Image (runs after build-and-test succeeds)
  docker-build:
    runs-on: ubuntu-latest
    needs: build-and-test  # Only run if build-and-test passes
    
    steps:
      # Step 1: Get your code
      - name: Checkout code
        uses: actions/checkout@v4
      
      # Step 2: Build Docker image (but don't push it yet)
      - name: Build Docker image
        run: |
          docker build -f BeloteEngine.Api/Dockerfile -t belote-backend:latest .
        # -f: Path to Dockerfile
        # -t: Tag/name for the image
        # .: Build context (current directory)
      
      # Step 3: Test that the image was built successfully
      - name: Verify Docker image
        run: docker images | grep belote-backend