name: CI/CD - BeloteEngine

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  GCP_REGION: europe-west8
  SERVICE_NAME: beloteengine

jobs:
  # ── Job 1: Build & Test ──────────────────────────────────────────────────────
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0"

      - name: Restore dependencies
        run: dotnet restore BeloteEngine.sln /p:SpaProxyLaunchEnabled=false

      - name: Build
        run: dotnet build BeloteEngine.sln --configuration Release --no-restore /p:SpaProxyLaunchEnabled=false

      - name: Run tests
        run: dotnet test BeloteEngine.sln --no-build --verbosity normal

  # ── Job 2: Build & verify production Docker image ────────────────────────────
  docker-build-production:
    runs-on: ubuntu-latest
    needs: build-and-test

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build production Docker image
        run: docker build -t beloteengine:prod .

      - name: Test container starts and is healthy
        run: |
          docker run -d --name test-container \
            -e ASPNETCORE_ENVIRONMENT=Production \
            -e AllowedOrigins=http://localhost \
            -e AllowedHosts="*" \
            -p 8081:8081 \
            beloteengine:prod

          echo "Waiting for container to be healthy..."
          for i in $(seq 1 15); do
            if curl -sf http://localhost:8081/health; then
              echo "Container is healthy!"
              break
            fi
            echo "Attempt $i/15 — not ready yet..."
            sleep 2
          done

          docker logs test-container
          docker stop test-container
          docker rm test-container

  # ── Job 3: Push image & deploy to Google Cloud Run ───────────────────────────
  deploy:
    runs-on: ubuntu-latest
    needs: docker-build-production
    # Only deploy on a real push to main — skip for pull requests
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    permissions:
      contents: read
      id-token: write # Required for Workload Identity Federation (keyless auth)

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Authenticate to Google Cloud using Workload Identity Federation (no JSON key needed)
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      # Authorize Docker to push to Artifact Registry
      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker ${{ env.GCP_REGION }}-docker.pkg.dev --quiet

      # Build + push the image tagged with the git SHA for traceability
      - name: Build and push Docker image
        env:
          IMAGE: ${{ env.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/belote/beloteengine
        run: |
          docker build \
            -t $IMAGE:${{ github.sha }} \
            -t $IMAGE:latest \
            .
          docker push $IMAGE:${{ github.sha }}
          docker push $IMAGE:latest

      # Deploy to Cloud Run
      - name: Deploy to Cloud Run
        id: deploy
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: ${{ env.SERVICE_NAME }}
          region: ${{ env.GCP_REGION }}
          image: ${{ env.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/belote/beloteengine:${{ github.sha }}
          env_vars: |
            ASPNETCORE_ENVIRONMENT=Production
            AllowedOrigins=https://online-belote-sspeevs-projects.vercel.app
            AllowedHosts=*
          flags: |
            --allow-unauthenticated
            --port=8081
            --min-instances=0
            --max-instances=10
            --memory=256Mi
            --cpu=1
            --timeout=300
            --session-affinity

      - name: Show deployed URL
        run: echo "Deployed to ${{ steps.deploy.outputs.url }}"
