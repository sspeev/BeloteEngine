# This is the name that appears in GitHub Actions tab
name: CI - BeloteEngine

# When should this workflow run?
on:
  push:
    branches: [ main ]  # Run on pushes to main
  pull_request:
    branches: [ main ]  # Run on PRs targeting main

# Define what jobs to run
jobs:
  # Job 1: Build and Test
  build-and-test:
    # What type of machine to run on (GitHub provides this for free)
    runs-on: ubuntu-latest
    
    steps:
      # Step 1: Get your code from the repository
      - name: Checkout code
        uses: actions/checkout@v4
      
      # Step 2: Install . NET SDK
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0'
      
      # Step 3: Restore dependencies
      - name: Restore dependencies
        run: dotnet restore BeloteEngine.sln
      
      # Step 4: Build the project
      - name: Build
        run: dotnet build BeloteEngine.sln --configuration Release --no-restore
      
      # Step 5: Run tests
      - name: Run tests
        run: dotnet test BeloteEngine.sln --no-build --verbosity normal
        # Note: This will pass even if you have no tests yet
  
  # Job 2: Build Production Docker Image
  docker-build-production:
    runs-on:  ubuntu-latest
    needs: build-and-test  # Only run if build-and-test passes
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      # Build production Docker image
      - name: Build production Docker image
        run: |
          docker build -f src/BeloteEngine.Api/Dockerfile -t beloteengine-prod:prod .
      
      # Verify the image was built
      - name: Verify Docker image
        run: docker images | grep beloteengine-prod
      
      # Test that the container starts successfully
      - name: Test container startup
        run: |
          docker run -d --name test-container -p 8081:8081 beloteengine-prod:prod
          sleep 10
          docker ps | grep test-container
          docker logs test-container
          docker stop test-container
          docker rm test-container

  # Job 3: Build and Test Development Docker Setup
  docker-build-development:
    runs-on: ubuntu-latest
    needs: build-and-test
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      # Build development Docker image
      - name: Build development Docker image
        run: |
          docker build -f src/BeloteEngine.Api/DockerfileDev -t beloteengine-dev:dev .
      
      # Test with docker-compose
      - name: Test with Docker Compose (Development)
        run: |
          docker compose -f compose.yaml up -d
          sleep 15
          docker compose -f compose.yaml ps
          docker compose -f compose.yaml logs backend
      
      # Check if backend is responding (optional - add health endpoint first)
      # - name: Health check
      #   run: |
      #     curl -f http://localhost:8081/health || exit 1
      
      # Cleanup
      - name: Cleanup
        if: always()
        run: |
          docker compose -f compose.yaml down
          docker system prune -f